#!/bin/bash

arr=("5554" "5556" "5558" "5560" "5562" "5564" "5566" "5568" "5570" "5572" "5574" "5576")

## now loop through the above array
for i in "${arr[@]}"
do
	if ($ANDROID_HOME/platform-tools/adb devices | grep -q $i)
	then
		$ANDROID_HOME/platform-tools/adb -s emulator-$i shell ls > /dev/null 2>&1 &
		PID=$!
		sleep 10
		if ps -p $PID > /dev/null
		then
			echo "Emulator $i is not responding! Kill it..."
			ps -ef | grep $i | grep -v grep | awk '{print $2}' | xargs kill -9
			curl -d "token=$i&status=shutdown&startedAt=-1&busySince=-1&ype=emulator&platform=android" -G GET http://localhost:8700/api/v1/devices/udpate
		else
			echo "Emulator $i is responding."
			if ($ANDROID_HOME/platform-tools/adb -s emulator-$i shell getprop sys.boot_completed | grep -q 1)
			then
				echo "Emulator booted!"
			else
				echo "Emulator is booting..."
				sleep 60
				if ($ANDROID_HOME/platform-tools/adb -s emulator-$i shell getprop sys.boot_completed | grep -q 1)
				then
					echo "Emulator booted!"
				else
					echo "Emulator $i failed to boot! Kill it..."
					ps -ef | grep $i | grep -v grep | awk '{print $2}' | xargs kill -9				
				fi
			fi
		fi
	fi
done


# Kill log processes that are not spawned by simctl
# ps -ef | grep 'log stream' | grep -v simctl | grep -v grep | awk '{print $2}' | xargs kill -9
