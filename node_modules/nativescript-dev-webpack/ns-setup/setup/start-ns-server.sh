#!/bin/bash
set -e

# Install Server
(
    echo $MONGODB_STORAGE
    mkdir $HOME/git && true
    cd $HOME/git
    ns clone mobile-devices-controller-server
    cd mobile-devices-controller-server
    npm i
    cd ..
    npm un -g mobile-devices-controller-server || true
    npm i -g mobile-devices-controller-server/
)

if [[ "$OSTYPE" == "darwin"* ]]; then
    brew services restart mongodb
    sleep 60
fi

if [[ "$OSTYPE" == "darwin"* ]]; then
    ns-server --mongodb </dev/null >/dev/null 2>&1 > server.log &
else
    ns-server --mongodb 2>&1 > server.log &
fi
sleep 60
curl http://localhost:$DEVICE_CONTROLLER_SERVER_PORT/api/v1/devices/refresh
sleep 30
