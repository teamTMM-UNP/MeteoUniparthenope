#!/bin/bash

# Sample usage:
# ./ns-setup/ci/project-update-modules.sh TestApp

# Spec:
# If current folder contains release then use $MODULES_VERSION from Sinopia
# Else use tns-core-modules.tgz

set -e

if [ ! "$#" -eq 1 ]; then
    echo "Illegal number of parameters"
    echo "Sample usage:" 
    echo "./ns-setup/ci/project-update-modules.sh TestApp"
    exit 1
fi

app=$1
if [[ "$PWD" == *hotfix* ]]; then
    echo "You are in hotfix branch. Will use Sinopia ..."
    node_modules/.bin/tns plugin remove tns-core-modules --path $app
    node_modules/.bin/tns plugin add tns-core-modules@$FIX_MODULES --path $app
elif [[ "$PWD" == *release* ]]; then
    echo "You are in release branch. Will use Sinopia ..."
    node_modules/.bin/tns plugin remove tns-core-modules --path $app
    node_modules/.bin/tns plugin add tns-core-modules@rc --path $app
else
    echo "You are in master branch. Will use tns-ios.tgz ..."
    cd $app
    echo "DEBUG: widgets"
    npm uninstall tns-core-modules-widgets --save || true
    npm install ../tns-core-modules-widgets.tgz --save
    echo "DEBUG: modules"
    npm uninstall tns-core-modules --save || true
    npm install ../tns-core-modules.tgz --save
    echo "DEBUG: widgets"
    cd node_modules/tns-core-modules
    npm uninstall --save tns-core-modules-widgets || true
    cd ../../../
    # Reinstall typescript plugin so it gets a chance to migrate
    # the tsconfig.json file
    if grep -q "nativescript-dev-typescript" "$app/package.json" ; then
        echo "TypeScript project detected. Updating plugin..."
        (cd "$app" && \
            npm uninstall nativescript-dev-typescript --save-dev; \
            npm install nativescript-dev-typescript@latest --save-dev)
    fi
fi

# # Reinstall typescript plugin so it gets a chance to migrate
# # the tsconfig.json file
# if grep -q "nativescript-dev-typescript" "$app/package.json" ; then
#     echo "TypeScript project detected. Updating plugin..."
#     (cd "$app" && \
#         npm uninstall nativescript-dev-typescript --save-dev; \
#         npm install nativescript-dev-typescript@latest --save-dev)
# fi
