#!/bin/bash
set -e

CLI_PACKAGE=nativescript.tgz
CLI_STORAGE_PATH=/tns-dist/CLI

while [ "$1" != "" ]; do
    case $1 in
        -b | --branch ) shift
                    BRANCH=$1
                    cp ${CLI_STORAGE_PATH}/${BRANCH}/${CLI_PACKAGE} .
                    echo "Current branch is: ${BRANCH}"
                    echo "CLI is successfully downloaded from ${CLI_STORAGE_PATH}/${CLI_PACKAGE}";;
         -g )
                   ISGLOBAL=-g
                   echo "SHOULD INSTALL GLOBAL ${ISGLOBAL}";;
    esac
    shift
done

echo "Clean npm cache"
npm cache clean && true

# echo "Uninstalling CLI ..."
# npm uninstall ${ISGLOBAL} nativescript --ignore-scripts

echo "Clear local CLI installation"
rm -fr ${PWD}/node_modules

echo "Installing CLI ..."
npm i ${ISGLOBAL} ${CLI_PACKAGE} --ignore-scripts

TNS=node_modules/.bin/tns
if [ "${ISGLOBAL}" != "-g" ]; then
    if [ -f ${PWD}/node_modules/.bin/tns ]; then
        echo "${PWD}/node_modules/.bin/tns exists."
    else
        echo "${PWD}/node_modules/.bin/tns DOES NOT exists!"
        exit 1
    fi

    if [ -f ${PWD}/node_modules/nativescript/bin/tns ]; then
        echo "${PWD}/node_modules/nativescript/bin/tns exists."
    else
        echo "${PWD}/node_modules/nativescript/bin/tns DOES NOT exists!"
        exit 1
    fi
fi

${TNS} usage-reporting disable
${TNS} error-reporting disable

echo "CLI version"
${TNS} --version
