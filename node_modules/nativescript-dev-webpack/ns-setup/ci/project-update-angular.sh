#!/bin/bash

# Sample usage:
# ./ns-setup/ci/project-update-modules.sh TestApp

# Spec:
# If current folder contains release then use $ANGULAR_VERSION from Sinopia
# Else use tns-core-modules.tgz

set -e

install_plugin() {
    app=$1
    if [[ "$PWD" == *hotfix* ]]; then
        echo "You are in hotfix branch. Will use Sinopia ..."
        (cd "$app" && npm install "nativescript-angular@$FIX_NS_NG" --save)
    elif [[ "$PWD" == *release* ]]; then
        echo "You are in release branch. Will use Sinopia ..."
        (cd "$app" && npm install "nativescript-angular@$ANGULAR_VERSION" --save)
    else
        tgz_path="$(pwd)/nativescript-angular.tgz"
        (cd "$app" && npm install "$tgz_path" --save)
    fi
}

if [ "$#" -lt 1 ]; then
    echo "Illegal number of parameters"
    echo "Sample usage:" 
    echo "./ns-setup/ci/project-update-angular.sh TestApp [-u]"
    exit 1
fi

app=$1
upgrade=$2
echo "Remove nativescript-angular plugin"
(cd "$app" && npm uninstall nativescript-angular || true)
install_plugin "$app"

if [ "$upgrade" == "-u" ] ; then
    echo "Upgrading app dependencies..."
    "$app/node_modules/.bin/update-app-ng-deps"
    (cd "$app" && npm install)
    install_plugin "$app"
fi
