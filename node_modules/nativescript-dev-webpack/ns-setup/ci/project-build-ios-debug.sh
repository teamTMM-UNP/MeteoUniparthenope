#!/bin/bash
set -e
echo "Build iOS"
if [ "$#" -eq 2 ]; then
    appDir=$1
    packageId=$appDir
    outFile=$2
else
    if [ "$#" -eq 3 ]; then
        appDir=$1
        packageId=$2
        outFile=$3
    else
        echo "Illegal number of parameters"
    fi
fi
echo "TestApp Folder: $appDir"
echo "PackageId: $packageId"
echo "Output File: $outFile"
node_modules/.bin/tns build ios --path $appDir
tar -czf $packageId.tgz --directory=$appDir/platforms/ios/build/emulator $packageId.app
mv $packageId.tgz out/$outFile.tgz

# rm -rf $appDir/platforms/ios

set +e
xcodebuild -version | grep '8.' &> /dev/null
if [ $? == 0 ]; then
    echo "Xcode 8 detected, update build.xcconfig"
    echo "DevTeam: $DEVELOPMENT_TEAM"
    sed -i bak -e "s|YOUR_TEAM_ID|${DEVELOPMENT_TEAM}|g" $appDir/app/App_Resources/iOS/build.xcconfig
    sed -i bak -e "s|// DEVELOPMENT_TEAM|DEVELOPMENT_TEAM|g" $appDir/app/App_Resources/iOS/build.xcconfig
    echo "build.xcconfig now looks like this:"
    cat $appDir/app/App_Resources/iOS/build.xcconfig
else
    echo "Xcode 7 detected, no need to update build.xcconfig"
fi
set -e
node_modules/.bin/tns build ios --forDevice --path $appDir
mv $appDir/platforms/ios/build/device/$packageId.ipa out/$outFile.ipa
