#!/bin/bash
set -e

extension='.tgz' # .tgz
postfix='-stable' # -stable

file_name_postfix_extension=$1 # UnitTestApp-stable.tgz
file_name_postfix=${file_name_postfix_extension%$extension} # UnitTestApp-stable
file_name=${file_name_postfix%$postfix} # UnitTestApp

echo_vars() {
    echo $extension
    echo $postfix
    echo $file_name_postfix_extension
    echo $file_name_postfix
    echo $file_name
}

extract_ios() {
    echo "Extract $file_name_postfix_extension:" $(date)
    rm -rf $file_name
    mkdir $file_name
    tar -xzf $file_name_postfix_extension -C $file_name
}

repackage_ios() {
    echo "Repacakge $file_name:" $(date)
    rm -rf $file_name/TestApp.app/app/tns_modules/tns-core-modules/*
    cp -R modules/* $file_name/TestApp.app/app/tns_modules/tns-core-modules/

    if [[ $file_name == *UnitTest* ]]; then
        echo "Copying UnitTest ..."
        cp -R tests/* $file_name/TestApp.app/app/
    elif [[ $file_name == *Cuteness* ]]; then
        echo "Copying CutenessIO ..."
        rm -fr $file_name/TestApp.app/app/cuteness.io/*
        cp -R apps/cuteness.io/* $file_name/TestApp.app/app/cuteness.io/
        # touch $file_name/TestApp.app/app/package.json
        # echo "{ \"name\": \"cuteness-io\" }" >> $file_name/TestApp.app/app/package.json
        # touch $file_name/TestApp.app/app/index.js
        # echo "require(\"./cuteness.io/app\");" >> $file_name/TestApp.app/app/index.js
        echo "Update Cuteness to local feed:"
        sed -i -e "s/(1000)/(50)/g" $file_name/TestApp.app/app/cuteness.io/reddit-app-view-model.js
        sed -i -e "s/https/http/g" $file_name/TestApp.app/app/cuteness.io/reddit-app-view-model.js
        sed -i -e "s/www.reddit.com\/r/nsbuild01.telerik.com/g" $file_name/TestApp.app/app/cuteness.io/reddit-app-view-model.js
    elif [[ $file_name == *UITests* ]]; then
        echo "Copying UITests ..."
        rm -fr $file_name/TestApp.app/app/ui-tests-app/*
        cp -R apps/ui-tests-app/* $file_name/TestApp.app/app/ui-tests-app/
    fi

    find $file_name -name '*.ios.js' -exec bash -c 'mv $0 ${0/.ios.js/.js}' {} \;
    cd $file_name
    tar -czf $file_name.tgz TestApp.app
    cd ..
    mv $file_name/$file_name.tgz out/$file_name.tgz

    if [ ! -f out/$file_name.tgz ]; then
        echo "Failed to build $file_name for iOS!"
        exit 1
    fi
}

echo_vars
extract_ios
repackage_ios
