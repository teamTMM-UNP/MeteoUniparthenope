#!/bin/bash
set -e

build_modules() {
    echo "Build $1:" $(date)
    cd $1
    rm -rf bin/dist
    npm install
    npm run tslint
    grunt just-build
    grunt pack-apps
    grunt get-ready-packages
    ./node_modules/typescript/bin/tsc  -p ./apps/
    cd ..
}

verify_build() {
    if [ -d $1/bin/dist/tns-core-modules ]; then
        echo "$1 build succeeded!"
    else
        echo "$1 build FAILed! Hint: Check out for TypeScript errors."
        exit 1
    fi
}

extract_package() {
    if [ -f $1 ]; then
        echo "Extract $1 to $2:" $(date)
        rm -rf $2
        mkdir $2
        tar -xzf $1
        mv package/* $2/
        rm -fr package
    else
        echo "$1 NOT found!"
        exit 1
    fi
}

build_modules NativeScript
verify_build NativeScript

echo "Copy local packages:" $(date)
cp NativeScript/bin/dist/tns-core-modules-*.tgz tns-core-modules.tgz
cp NativeScript/bin/dist/tns-samples-tests-*.tgz tns-samples-tests.tgz
cp NativeScript/bin/dist/tns-samples-apps-*.tgz tns-samples-apps.tgz

extract_package tns-core-modules.tgz modules
extract_package tns-samples-tests.tgz tests
extract_package tns-samples-apps.tgz apps
