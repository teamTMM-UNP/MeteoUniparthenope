#!/bin/bash
set -e

extension='.apk' # .apk
postfix='-stable' # -stable

file_name_postfix_extension=$1 # UnitTestApp-release-stable.apk
file_name_postfix=${file_name_postfix_extension%$extension} # UnitTestApp-release-stable
file_name=${file_name_postfix%$postfix} # UnitTestApp-release

echo_vars() {
    echo $extension
    echo $postfix
    echo $file_name_postfix_extension
    echo $file_name_postfix
    echo $file_name
}

extract_android() {
    echo "Extract $file_name_postfix_extension:" $(date)
    rm -fr $file_name_postfix $file_name
    apktool d $file_name_postfix_extension
    mv $file_name_postfix $file_name
}

repackage_android() {
    echo "Repackage $file_name:" $(date)
    rm -fr $file_name/assets/app/tns_modules/tns-core-modules/*
    cp -R modules/* $file_name/assets/app/tns_modules/tns-core-modules/
    
    if [[ $file_name == *UnitTest* ]]; then
        echo "Copying UnitTest ..."
        cp -fR tests/* $file_name/assets/app/
    elif [[ $file_name == *Cuteness* ]]; then
        echo "Copying CutenessIO ..."
        rm -fr $file_name/assets/app/cuteness.io/*
        cp -R apps/cuteness.io/* $file_name/assets/app/cuteness.io/
        # touch $file_name/assets/app/package.json
        # echo "{ \"name\": \"cuteness-io\" }" >> $file_name/assets/app/package.json
        # touch $file_name/assets/app/index.js
        # echo "require(\"./cuteness.io/app\");" >> $file_name/assets/app/index.js
        echo "Update Cuteness to local feed:"
        sed -i -e "s/(1000)/(50)/g" $file_name/assets/app/cuteness.io/reddit-app-view-model.js
        sed -i -e "s/https/http/g" $file_name/assets/app/cuteness.io/reddit-app-view-model.js
        sed -i -e "s/www.reddit.com\/r/nsbuild01.telerik.com/g" $file_name/assets/app/cuteness.io/reddit-app-view-model.js
    elif [[ $file_name == *UITests* ]]; then
        echo "Copying UITests ..."
        rm -fr $file_name/assets/app/ui-tests-app/*
        cp -R apps/ui-tests-app/* $file_name/assets/app/ui-tests-app/
    fi

    ## HACK!
    sed -i '' '/OptionsPanel/d' $file_name/res/values-v24/styles.xml || true
    sed -i '' '/LockScreen/d' $file_name/res/values-v24/styles.xml || true

    find $file_name -name '*.android.js' -exec bash -c 'mv $0 ${0/.android.js/.js}' {} \;
    apktool b $file_name -o out/$file_name.apk

    if [ ! -f out/$file_name.apk ]; then
        echo "Failed to build $file_name.apk for Android!"
        exit 1
    fi
}

sign_jar() {
    # Debug: -verbose
    jarsigner -keystore ~/keystore/Telerik.keystore -storepass t3l3r1kad -keypass t3l3r1kad out/$file_name.apk Telerik
}

echo_vars
extract_android
repackage_android
sign_jar
